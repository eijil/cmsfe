import{nanoid as d}from"nanoid";import w from"pako";import{UAParser as f}from"ua-parser-js";var l=n=>{n=n||(typeof window<"u"?window.navigator.userAgent:"");let e=f(n),{device:t,ua:a,os:i}=e;return{uaParser:e,isMobile:t.type==="mobile",isFB:u(a),isAndroid:i.name==="Android",isIOS:i.name==="iOS",isTablet:t.type==="tablet",isMac:i.name==="Mac OS",isApp:location.search.includes("rsApp")}},u=n=>/FBAN|FBAV|FB_IAB|FB_IABV_SIMULATOR/.test(n);import{Buffer as h}from"buffer";var s=l(),g={},c=class n{VERSION;APP_ID;CHANNEL_ID;PACKAGE_NAME;REPORT_API;static instance;constructor(e){this.REPORT_API=e.reportAPI,this.VERSION=e.version,this.APP_ID=e.appId,this.CHANNEL_ID=e.channelId,this.PACKAGE_NAME=e.packageName||"h5"}static getInstance(e){return n.instance||(n.instance=new n(e)),n.instance}eventReport({event_name:e,sub_event_name:t,properties:a,ctime:i},r){if(r&&g[r])return;let o={_event_name:e,_sub_event_name:t,properties:a};try{this.reportHandle(o,i)}catch(_){console.log("\u4E0A\u62A5\u5931\u8D25",_)}r&&(g[r]=!0)}pageEnter(e){this.reportHandle({_event_name:"m_page_enter",properties:{...e,_referrer_url:document==null?void 0:document.referrer}})}installReport(){let{uaParser:e}=s,t="";s.isMobile?t="phone":s.isTablet?t="tablet":s.isMac?t="mac":t="pc",localStorage.getItem("_app_install_id")||this.reportHandle({_event_name:"m_app_install",properties:{_device_brand:"",_device_model:"",_device_screen_h:window.screen.height,_device_screen_w:window.screen.width,_device_ram:0,_device_lang:"en",_device_category:t,browser_brand:e.browser.name,browser_version:e.browser.version,_ua:navigator.userAgent,_url:window.location.href,_referrer_url:document==null?void 0:document.referrer}})}getBaseInfo(){let{uaParser:e}=s,t=e.os.name?e.os.name.toLowerCase():"",a={_app_id:this.APP_ID,_app_channel_id:this.CHANNEL_ID,_app_version:this.VERSION,_package_name:this.PACKAGE_NAME,_app_game_version:"",_app_res_version:"",_app_install_id:localStorage.getItem("_app_install_id")||"",_app_activate_id:sessionStorage.getItem("_app_activate_id")||"",_device_id:"",_ad_id:"",_androidid:"",_idfv:"",_os_type:t,_os_version:"",_os_timezone_offset:"utc_offset=-8:00",_os_timestamp:Math.floor(new Date().getTime()/1e3),_device_network_type:0,_app_user_id:localStorage.getItem("uid")||"",_app_lang:(navigator==null?void 0:navigator.language)||(navigator==null?void 0:navigator.userLanguage)||"",_event_name:"",_sub_event_name:"",properties:{}},i=new Date().getTimezoneOffset()/60,r=(new Date().getTimezoneOffset()%60).toString().padStart(2,"0");if(a._os_timezone_offset=`utc_offset=${i}:${r}`,!localStorage.getItem("_app_install_id")){let o=d();a._app_install_id=o,localStorage.setItem("_app_install_id",o.toString())}if(!sessionStorage.getItem("_app_activate_id")){let o=d();a._app_activate_id=o,sessionStorage.setItem("_app_activate_id",o.toString())}return a}reportHandle(e,t){let a=this.getBaseInfo();t&&(a._os_timestamp=t);let i={...a,...e};this.send(i)}async send(e){console.log("\u4E0A\u62A5\u4FE1\u606F",e);let t=w.deflate(JSON.stringify([e])),a=h.from(t);return await fetch(this.REPORT_API,{method:"POST",body:a.toString("base64")}).catch(r=>{console.log("\u4E0A\u62A5\u5931\u8D25",r)})}},b=c;var m="webToNative",v="nativeToWeb",p=class{nativeCallbacks=new Map;constructor(){typeof window>"u"||this.registerCallback()}registerCallback(){window[v]=e=>{var t;try{typeof e=="string"&&(e=JSON.parse(e));let{id:a,name:i}=e;(t=this.nativeCallbacks.get(`${a}_${i}`))==null||t(e)}catch(a){console.log(a)}}}init(e){for(let t in e){let a=e[t];a&&this.nativeCallbacks.set(t,a)}}exec(e,t){let{callback:a,...i}=t||{},r=Date.now().toString(),o={id:r,name:e,params:i};a&&this.nativeCallbacks.set(`${r}_${e}`,a);try{this.postMessage(o)}catch(_){this.errorCallBack({id:r,message:_.toString(),name:e})}return o}postMessage=e=>{if(window.webkit){let t={...e,params:e.params};this.iosMessage(t)}else if(window!=null&&window.Android)this.androidMessage(JSON.stringify(e));else throw new Error("current environment not support")};errorCallBack(e){window[v]({code:-1,id:e.id,name:e.name,message:e.message})}iosMessage=e=>{var a;let t=(a=window.webkit)==null?void 0:a.messageHandlers[m];if(!t)throw new Error("ios version too low");t.postMessage(e)};androidMessage=e=>{window==null||window.Android[m](e)}},I=new p;export{b as ReportSDK,I as webview};
//# sourceMappingURL=index.js.map