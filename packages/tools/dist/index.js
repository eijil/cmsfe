import{nanoid as d}from"nanoid";import u from"pako";import{UAParser as v}from"ua-parser-js";var l=r=>{r=r||(typeof window<"u"?window.navigator.userAgent:"");let e=v(r),{device:t,ua:a,os:i}=e;return{uaParser:e,isMobile:t.type==="mobile",isFB:f(a),isAndroid:i.name==="Android",isIOS:i.name==="iOS",isTablet:t.type==="tablet",isMac:i.name==="Mac OS",isApp:location.search.includes("rsApp")}},f=r=>/FBAN|FBAV|FB_IAB|FB_IABV_SIMULATOR/.test(r);import{Buffer as w}from"buffer";var o=l(),g={},p=class r{VERSION;APP_ID;CHANNEL_ID;PACKAGE_NAME;REPORT_API;static instance;constructor(e){this.REPORT_API=e.reportAPI,this.VERSION=e.version,this.APP_ID=e.appId,this.CHANNEL_ID=e.channelId,this.PACKAGE_NAME=e.packageName||"h5"}static getInstance(e){return r.instance||(r.instance=new r(e)),r.instance}eventReport({event_name:e,sub_event_name:t,properties:a,ctime:i},n){if(n&&g[n])return;let s={_event_name:e,_sub_event_name:t,properties:a};try{this.reportHandle(s,i)}catch(_){console.log("\u4E0A\u62A5\u5931\u8D25",_)}n&&(g[n]=!0)}pageEnter(e){this.reportHandle({_event_name:"m_page_enter",properties:{...e,_referrer_url:document==null?void 0:document.referrer}})}installReport(){let{uaParser:e}=o,t="";o.isMobile?t="phone":o.isTablet?t="tablet":o.isMac?t="mac":t="pc",localStorage.getItem("_app_install_id")||this.reportHandle({_event_name:"m_app_install",properties:{_device_brand:"",_device_model:"",_device_screen_h:window.screen.height,_device_screen_w:window.screen.width,_device_ram:0,_device_lang:"en",_device_category:t,browser_brand:e.browser.name,browser_version:e.browser.version,_ua:navigator.userAgent,_url:window.location.href,_referrer_url:document==null?void 0:document.referrer}})}getBaseInfo(){let{uaParser:e}=o,t=e.os.name?e.os.name.toLowerCase():"",a={_app_id:this.APP_ID,_app_channel_id:this.CHANNEL_ID,_app_version:this.VERSION,_package_name:this.PACKAGE_NAME,_app_game_version:"",_app_res_version:"",_app_install_id:localStorage.getItem("_app_install_id")||"",_app_activate_id:sessionStorage.getItem("_app_activate_id")||"",_device_id:"",_ad_id:"",_androidid:"",_idfv:"",_os_type:t,_os_version:"",_os_timezone_offset:"utc_offset=-8:00",_os_timestamp:Math.floor(new Date().getTime()/1e3),_device_network_type:0,_app_user_id:localStorage.getItem("uid")||"",_app_lang:(navigator==null?void 0:navigator.language)||(navigator==null?void 0:navigator.userLanguage)||"",_event_name:"",_sub_event_name:"",properties:{}},i=new Date().getTimezoneOffset()/60,n=(new Date().getTimezoneOffset()%60).toString().padStart(2,"0");if(a._os_timezone_offset=`utc_offset=${i}:${n}`,!localStorage.getItem("_app_install_id")){let s=d();a._app_install_id=s,localStorage.setItem("_app_install_id",s.toString())}if(!sessionStorage.getItem("_app_activate_id")){let s=d();a._app_activate_id=s,sessionStorage.setItem("_app_activate_id",s.toString())}return a}reportHandle(e,t){let a=this.getBaseInfo();t&&(a._os_timestamp=t);let i={...a,...e};this.send(i)}async send(e){console.log("\u4E0A\u62A5\u4FE1\u606F",e);let t=u.deflate(JSON.stringify([e])),a=w.from(t);return await fetch(this.REPORT_API,{method:"POST",body:a.toString("base64")}).catch(n=>{console.log("\u4E0A\u62A5\u5931\u8D25",n)})}},h=p;var m="webToNative",I="nativeToWeb",c=class{nativeCallbacks=new Map;constructor(){typeof window>"u"||this.registerCallback()}registerCallback(){window[I]=e=>{var t;try{typeof e=="string"&&(e=JSON.parse(e));let{id:a,name:i}=e;(t=this.nativeCallbacks.get(`${a}_${i}`))==null||t(e)}catch(a){console.log(a)}}}exec(e,t){let{callback:a,...i}=t||{},n=Date.now().toString(),s={id:n,name:e,params:i};try{this.postMessage(s)}catch(_){console.log(_)}return a&&this.nativeCallbacks.set(`${n}_${e}`,a),s}postMessage=e=>{if(window.webkit){let t={...e,params:e.params};this.iosMessage(t)}else window!=null&&window.Android&&this.androidMessage(JSON.stringify(e))};iosMessage=e=>{var a;let t=(a=window.webkit)==null?void 0:a.messageHandlers[m];if(!t)throw new Error("\u7248\u672C\u8FC7\u4F4E");t.postMessage(e)};androidMessage=e=>{window==null||window.Android[m](e)}},b=new c;export{h as ReportSDK,b as webview};
//# sourceMappingURL=index.js.map